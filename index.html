<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Patient Health Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; background:#020617; color:white; text-align:center; }
h1,h2,h3 { margin:10px 0; }
input { padding:10px; border-radius:8px; border:none; width:80%; margin:10px 0; }
button { cursor:pointer; padding:8px 16px; border-radius:8px; border:none; margin:5px; }
.hidden { display:none; }
.alert { background:#dc2626; padding:10px; margin:10px auto; width:90%; display:none; border-radius:8px; font-weight:bold; }
.card { background:#1e293b; margin:10px auto; padding:15px; width:320px; border-radius:10px; font-size:18px; cursor:pointer; transition:0.3s; }
.card:hover { box-shadow:0 0 15px #00f; }
.trend-up { color:limegreen; font-weight:bold; }
.trend-down { color:red; font-weight:bold; }
.trend-neutral { color:gray; font-weight:bold; }
.filter-btn { background:#1e293b; color:white; }
.filter-btn.active { background:limegreen; color:black; }
#vital-chart { border-radius:10px; }
.value-time { font-size:16px; margin:2px 0; }
#report-header { display:flex; flex-direction:column; align-items:center; }
#chart-container { width:95vw; height:70vh; margin:10px auto; }
</style>
</head>
<body>

<!-- ================= PATIENT INPUT PAGE ================= -->
<div id="patient-page" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;">
  <h1>Enter Patient Name</h1>
  <input type="text" id="patientName" placeholder="Patient Name">
  <button onclick="startDashboard()">Start Monitoring</button>
</div>

<!-- ================= DASHBOARD PAGE ================= -->
<div id="dashboard-page" class="hidden">
  <h1>üì° Patient Health Dashboard</h1>
  <h2 id="patient-display">Patient: --</h2>
  <div id="alertBox" class="alert">‚ö† Abnormal Values Detected!</div>

  <div class="card" onclick="showReport('Body Temp',1,36,38)">üå° Body Temp: <span id="temp">--</span>¬∞C <span id="temp-trend" class="trend-neutral">‚Üí</span></div>
  <div class="card" onclick="showReport('SpO‚ÇÇ',2,92,100)">ü©∏ SpO‚ÇÇ: <span id="spo2">--</span>% <span id="spo2-trend" class="trend-neutral">‚Üí</span></div>
  <div class="card" onclick="showReport('BPM',3,50,120)">‚ù§Ô∏è BPM: <span id="bpm">--</span> <span id="bpm-trend" class="trend-neutral">‚Üí</span></div>
  <div class="card" onclick="showReport('Acceleration',4,0,20)">‚è± Acceleration: <span id="acc">--</span> m/s¬≤ <span id="acc-trend" class="trend-neutral">‚Üí</span></div>
  <div class="card" onclick="showReport('Room Temp',5,20,30)">üè† Room Temp: <span id="roomTemp">--</span>¬∞C <span id="roomTemp-trend" class="trend-neutral">‚Üí</span></div>
  <div class="card" onclick="showReport('Humidity',6,30,70)">üíß Humidity: <span id="humidity">--</span>% <span id="humidity-trend" class="trend-neutral">‚Üí</span></div>

  <button onclick="resetPatient()">Change Patient</button>
</div>

<!-- ================= MEDICAL REPORT PAGE ================= -->
<div id="report-page" class="hidden">
  <div id="report-header">
    <h1>Medical Report</h1>
    <h2 id="report-patient">Patient: --</h2>
    <h2 id="report-vital">Vital: --</h2>
    <p class="value-time" id="report-value">Latest Value: --</p>
    <p class="value-time" id="report-time">Last Updated: --</p>
    <p id="report-interpretation">Interpretation: --</p>
  </div>
  <div>
    <button class="filter-btn active" onclick="loadHistory('today')">Today</button>
    <button class="filter-btn" onclick="loadHistory('week')">This Week</button>
    <button class="filter-btn" onclick="loadHistory('all')">All</button>
  </div>
  <div id="chart-container">
    <canvas id="vital-chart"></canvas>
  </div>
  <button onclick="backToDashboard()">Back to Dashboard</button>
</div>

<script>
const CHANNEL_ID="3205334"; // Your ThingSpeak Channel ID
const READ_KEY="F1QQTII84R0NG0FX"; // Your read API key
let lastValues={1:null,2:null,3:null,4:null,5:null,6:null};
let patientName="--";
let vitalField=1;
let vitalMin=0,vitalMax=0;
let vitalChart;

// ================= PATIENT =================
function startDashboard(){
  const name=document.getElementById('patientName').value.trim();
  if(!name){ alert("Please enter patient name"); return; }
  patientName=name;
  document.getElementById('patient-display').innerText="Patient: "+patientName;
  document.getElementById('patient-page').classList.add('hidden');
  document.getElementById('dashboard-page').classList.remove('hidden');
  fetchDashboard();
  setInterval(fetchDashboard,15000);
}
function resetPatient(){
  document.getElementById('dashboard-page').classList.add('hidden');
  document.getElementById('patient-page').classList.remove('hidden');
}

// ================= DASHBOARD =================
async function fetchDashboard(){
  try{
    const res=await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_KEY}&results=2`);
    const data=await res.json();
    if(!data.feeds || data.feeds.length<2) return;
    const prev=data.feeds[0];
    const latest=data.feeds[1];
    const fields=[1,2,3,4,5,6];
    fields.forEach(f=>{
      const latestVal=parseFloat(latest[`field${f}`]);
      const prevVal=parseFloat(prev[`field${f}`]);
      let trend=prevVal? (latestVal>prevVal?"‚Üë":latestVal<prevVal?"‚Üì":"‚Üí"):"‚Üí";
      lastValues[f]=latestVal;
      let valueEl, trendEl;
      if(f===1){ valueEl=document.getElementById('temp'); trendEl=document.getElementById('temp-trend'); }
      if(f===2){ valueEl=document.getElementById('spo2'); trendEl=document.getElementById('spo2-trend'); }
      if(f===3){ valueEl=document.getElementById('bpm'); trendEl=document.getElementById('bpm-trend'); }
      if(f===4){ valueEl=document.getElementById('acc'); trendEl=document.getElementById('acc-trend'); }
      if(f===5){ valueEl=document.getElementById('roomTemp'); trendEl=document.getElementById('roomTemp-trend'); }
      if(f===6){ valueEl=document.getElementById('humidity'); trendEl=document.getElementById('humidity-trend'); }
      valueEl.innerText=latestVal;
      trendEl.innerText=trend;
      trendEl.className=trend==="‚Üë"?"trend-up":trend==="‚Üì"?"trend-down":"trend-neutral";
    });

    const alertBox=document.getElementById('alertBox');
    let alertText="";
    if(lastValues[3]<50 || lastValues[3]>120) alertText+="BPM ";
    if(lastValues[2]<92) alertText+="SpO‚ÇÇ ";
    if(lastValues[1]>38) alertText+="Body Temp ";
    if(lastValues[4]>20) alertText+="Acceleration ";
    if(lastValues[5]<18 || lastValues[5]>30) alertText+="Room Temp ";
    if(lastValues[6]<30 || lastValues[6]>70) alertText+="Humidity ";
    alertBox.innerText=alertText?`‚ö† Abnormal: ${alertText}`:"";
    alertBox.style.display=alertText?"block":"none";

  } catch(err){ console.error("Dashboard fetch error:",err); }
}

// ================= MEDICAL REPORT =================
function showReport(vitalName,fieldNum,minVal,maxVal){
  vitalField=fieldNum;
  vitalMin=minVal;
  vitalMax=maxVal;
  document.getElementById('dashboard-page').classList.add('hidden');
  document.getElementById('report-page').classList.remove('hidden');
  document.getElementById('report-patient').innerText="Patient: "+patientName;
  document.getElementById('report-vital').innerText="Vital: "+vitalName;
  const value=lastValues[fieldNum]!==null?lastValues[fieldNum]:"--";
  document.getElementById('report-value').innerText="Latest Value: "+value;
  const time= new Date().toLocaleString();
  document.getElementById('report-time').innerText="Last Updated: "+time;

  let interpretation="Normal";
  if(vitalName==="BPM") interpretation=(value<50||value>120)?"Abnormal BPM":"Normal BPM";
  if(vitalName==="SpO‚ÇÇ") interpretation=(value<92)?"Low SpO‚ÇÇ":"Normal SpO‚ÇÇ";
  if(vitalName==="Body Temp") interpretation=(value>38)?"High Body Temp":"Normal Body Temp";
  if(vitalName==="Acceleration") interpretation=(value>20)?"High Activity":"Normal Activity";
  if(vitalName==="Room Temp") interpretation=(value<18||value>30)?"Abnormal Room Temp":"Normal Room Temp";
  if(vitalName==="Humidity") interpretation=(value<30||value>70)?"Abnormal Humidity":"Normal Humidity";
  document.getElementById('report-interpretation').innerText="Interpretation: "+interpretation;

  loadHistory('today'); // default
}

function backToDashboard(){
  document.getElementById('report-page').classList.add('hidden');
  document.getElementById('dashboard-page').classList.remove('hidden');
}

// ================= HISTORY CHART =================
async function loadHistory(range){
  const buttons=document.querySelectorAll('.filter-btn');
  buttons.forEach(b=>b.classList.remove('active'));
  if(range==='today') buttons[0].classList.add('active');
  if(range==='week') buttons[1].classList.add('active');
  if(range==='all') buttons[2].classList.add('active');

  let results=50;
  if(range==='week') results=200;
  if(range==='all') results=800;

  try{
    const res=await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?api_key=${READ_KEY}&results=${results}`);
    const data=await res.json();
    const values=data.feeds.map(f=>parseFloat(f[`field${vitalField}`]));
    const labels=data.feeds.map(f=>new Date(f.created_at).toLocaleString());
    const pointBg = values.map(v=> (v<vitalMin||v>vitalMax)?'red':'lime');

    const ctx=document.getElementById('vital-chart').getContext('2d');
    if(vitalChart) vitalChart.destroy();
    vitalChart=new Chart(ctx,{
      type:'line',
      data:{
        labels:labels,
        datasets:[{
          label:'History',
          data:values,
          borderColor:'lime',
          backgroundColor:'rgba(0,255,0,0.2)',
          pointBackgroundColor:pointBg,
          fill:true,
          tension:0.3,
          pointRadius:4
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        scales:{
          y:{ beginAtZero:false, suggestedMin:vitalMin-5, suggestedMax:vitalMax+5, title:{ display:true, text:'Value'} },
          x:{ title:{ display:true, text:'Time'} }
        },
        plugins:{
          tooltip:{ callbacks:{ label:function(ctx){ return ctx.parsed.y+" at "+ctx.label; } } },
          legend:{ display:false }
        }
      }
    });

  } catch(err){ console.error("History fetch error:",err);}
}
</script>

</body>
</html>

